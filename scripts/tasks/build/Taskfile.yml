version: 3

tasks:
  bin:
    deps: [":base:clear"]
    sources:
      - ./cmd/**
      - ./internal/**
      - ./pkg/**
      - ./.git/**
      - ./go.mod
      - ./go.sum
      - ./Taskfile.yml
      - ./scripts/script/**
      - ./scripts/tasks/**
    generates:
      - ./data/cli/sshdev
    cmds:
      - mkdir -p ./data/cli
      - go build -ldflags "-s -w" -o ./data/cli/sshdev ./cmd/sshdev

  release:
    desc: "Build release binaries for multiple platforms"
    deps: [":base:clear"]
    sources:
      - ./cmd/sshdev/**
      - ./internal/**
      - ./pkg/**
      - ./.git/**
      - ./go.mod
      - ./go.sum
      - ./scripts/script/**
      - ./scripts/tasks/**
    generates:
      - ./data/release/sshdev-*
    cmds:
      - |
        mkdir -p ./data/release
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o ./data/release/sshdev-linux-amd64 ./cmd/sshdev
        GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o ./data/release/sshdev-linux-arm64 ./cmd/sshdev
        GOOS=darwin GOARCH=amd64 go build -ldflags "-s -w" -o ./data/release/sshdev-darwin-amd64 ./cmd/sshdev
        GOOS=darwin GOARCH=arm64 go build -ldflags "-s -w" -o ./data/release/sshdev-darwin-arm64 ./cmd/sshdev
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o ./data/release/sshdev-windows-amd64.exe ./cmd/sshdev

  linux:
    desc: "Build for Linux AMD64 (static)"
    deps: [":base:clear"]
    cmds:
      - mkdir -p ./data/cli
      - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o ./data/cli/sshdev ./cmd/sshdev

  deps:
    desc: "Download dependencies"
    cmds:
      - go mod download
      - go mod tidy

  docker:
    desc: "Build docker image"
    cmds:
      - docker build -t sshdev:latest .