version: 3

tasks:
  bin:
    desc: "构建二进制文件到 ./data/cli/sshdev"
    deps: [":base:clear"]
    sources:
      - ./cmd/**
      - ./internal/**
      - ./pkg/**
      - ./.git/**
      - ./go.mod
      - ./go.sum
      - ./Taskfile.yml
      - ./scripts/script/**
      - ./scripts/tasks/**
    generates:
      - ./data/cli/sshdev
    cmds:
      - mkdir -p ./data/cli
      - go build -ldflags "-s -w" -o ./data/cli/sshdev ./cmd/sshdev

  release:
    desc: "构建多平台发布版本"
    deps: [":base:clear"]
    sources:
      - ./cmd/sshdev/**
      - ./internal/**
      - ./pkg/**
      - ./.git/**
      - ./go.mod
      - ./go.sum
      - ./scripts/script/**
      - ./scripts/tasks/**
    generates:
      - ./data/release/sshdev-*
      - ./data/release/sshd.exe
    cmds:
      - |
        mkdir -p ./data/release
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o ./data/release/sshdev-linux-amd64 ./cmd/sshdev
        GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o ./data/release/sshdev-linux-arm64 ./cmd/sshdev
        GOOS=darwin GOARCH=amd64 go build -ldflags "-s -w" -o ./data/release/sshdev-darwin-amd64 ./cmd/sshdev
        GOOS=darwin GOARCH=arm64 go build -ldflags "-s -w" -o ./data/release/sshdev-darwin-arm64 ./cmd/sshdev
        # Windows: name it sshd.exe for VS Code Remote SSH compatibility
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o ./data/release/sshd.exe ./cmd/sshdev

  linux:
    desc: "构建 Linux AMD64 静态二进制"
    deps: [":base:clear"]
    cmds:
      - mkdir -p ./data/cli
      - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o ./data/cli/sshdev ./cmd/sshdev

  deps:
    desc: "下载依赖"
    deps: [":base:clear"]
    cmds:
      - go mod download
      - go mod tidy

  docker:
    desc: "构建 Docker 镜像"
    deps: [":base:clear"]
    cmds:
      - docker build -t sshdev:latest .